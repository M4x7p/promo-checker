<!doctype html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#0b1220" />
    <title>Promo Checker • DoHome นครสวรรค์</title>

    <!-- Google Font: Prompt -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg0: #070b12;
        --bg1: #0b1220;
        --card: rgba(255, 255, 255, 0.06);
        --border: rgba(255, 255, 255, 0.10);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.70);
        --muted2: rgba(255, 255, 255, 0.58);
        --orange: #f97316; /* DoHome-ish */
        --orange2: #fb923c;
        --greenBg: rgba(34, 197, 94, 0.14);
        --greenBd: rgba(34, 197, 94, 0.35);
        --greenTx: #86efac;
        --redBg: rgba(239, 68, 68, 0.14);
        --redBd: rgba(239, 68, 68, 0.35);
        --redTx: #fca5a5;
        --warnBg: rgba(245, 158, 11, 0.12);
        --warnBd: rgba(245, 158, 11, 0.35);
        --warnTx: #fcd34d;
        --shadow: 0 18px 48px rgba(0, 0, 0, 0.45);
        --radius: 18px;
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: "Prompt", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
        color: var(--text);
        background:
          radial-gradient(900px 600px at 20% -10%, rgba(249, 115, 22, 0.20), transparent 60%),
          radial-gradient(700px 500px at 90% 10%, rgba(59, 130, 246, 0.18), transparent 60%),
          radial-gradient(700px 500px at 50% 120%, rgba(34, 197, 94, 0.10), transparent 55%),
          linear-gradient(180deg, var(--bg0), var(--bg1));
      }

      .wrap {
        min-height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 22px 14px 34px;
      }

      .app {
        width: 100%;
        max-width: 520px;
      }

      .top {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 14px;
      }

      .logo {
        width: 54px;
        height: 54px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        box-shadow: 0 10px 28px rgba(0,0,0,0.35);
        flex: 0 0 auto;
      }
      .logo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .title {
        line-height: 1.15;
      }
      .title h1 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        letter-spacing: 0.2px;
      }
      .title .sub {
        margin-top: 4px;
        font-size: 13px;
        color: var(--muted2);
      }

      .panel {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .panel-inner {
        padding: 18px;
      }

      .hint {
        color: var(--muted);
        font-size: 13px;
        margin: 0 0 12px 0;
      }

      .form {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .field {
        position: relative;
      }

      input[type="tel"] {
        width: 100%;
        appearance: none;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(0, 0, 0, 0.22);
        color: var(--text);
        border-radius: 14px;
        padding: 14px 14px 14px 44px;
        font-size: 18px;
        font-weight: 600;
        letter-spacing: 2px;
        outline: none;
        transition: border-color 150ms ease, box-shadow 150ms ease, transform 150ms ease;
      }
      input[type="tel"]:focus {
        border-color: rgba(249, 115, 22, 0.55);
        box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.18);
        transform: translateY(-1px);
      }

      .icon-left {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        opacity: 0.9;
        color: var(--orange2);
      }

      .btn {
        width: 100%;
        border: 0;
        background: linear-gradient(180deg, var(--orange2), var(--orange));
        color: #1a120c;
        font-family: inherit;
        font-weight: 800;
        font-size: 16px;
        border-radius: 14px;
        padding: 14px 16px;
        cursor: pointer;
        transition: transform 120ms ease, filter 120ms ease, box-shadow 120ms ease;
        box-shadow: 0 14px 28px rgba(249, 115, 22, 0.25);
      }
      .btn:active { transform: translateY(1px) scale(0.99); }
      .btn:disabled {
        cursor: not-allowed;
        filter: grayscale(0.2) brightness(0.85);
        box-shadow: none;
      }

      .result {
        margin-top: 14px;
      }

      .card {
        border-radius: 16px;
        padding: 14px 14px 12px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.06);
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 12px;
        align-items: start;
        animation: pop 180ms ease-out;
      }

      @keyframes pop {
        from { transform: translateY(4px); opacity: 0.6; }
        to { transform: translateY(0); opacity: 1; }
      }

      .badge {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 900;
        border: 1px solid var(--border);
        background: rgba(0,0,0,0.18);
        user-select: none;
      }

      .card h2 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.2px;
      }

      .rows {
        margin-top: 8px;
        display: grid;
        gap: 6px;
        color: var(--muted);
        font-size: 14px;
        line-height: 1.35;
      }

      .rows b {
        color: rgba(255,255,255,0.86);
        font-weight: 700;
      }

      .note {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed rgba(255,255,255,0.16);
        color: rgba(255,255,255,0.78);
        font-size: 13px;
      }

      .card.success {
        background: var(--greenBg);
        border-color: var(--greenBd);
      }
      .card.success .badge {
        border-color: rgba(34, 197, 94, 0.50);
        background: rgba(34, 197, 94, 0.16);
        color: var(--greenTx);
      }

      .card.danger {
        background: var(--redBg);
        border-color: var(--redBd);
      }
      .card.danger .badge {
        border-color: rgba(239, 68, 68, 0.55);
        background: rgba(239, 68, 68, 0.16);
        color: var(--redTx);
      }

      .card.warning {
        background: var(--warnBg);
        border-color: var(--warnBd);
      }
      .card.warning .badge {
        border-color: rgba(245, 158, 11, 0.55);
        background: rgba(245, 158, 11, 0.14);
        color: var(--warnTx);
      }

      .footer {
        margin-top: 14px;
        color: rgba(255,255,255,0.45);
        font-size: 12px;
        text-align: center;
      }
      .footer code {
        color: rgba(255,255,255,0.65);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }

      @media (min-width: 520px) {
        .panel-inner { padding: 20px; }
        .title h1 { font-size: 20px; }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <main class="app" role="main">
        <header class="top" aria-label="Header">
          <div class="logo" title="โลโก้ DoHome (ใส่ไฟล์เอง)">
            <!-- Max: วางไฟล์โลโก้ชื่อ logo.png ในโฟลเดอร์เดียวกับ index.html แล้วจะแสดงอัตโนมัติ -->
            <img src="logo.png" alt="DoHome นครสวรรค์" onerror="this.style.display='none';" />
          </div>
          <div class="title">
            <h1>ตรวจสอบสินค้าเข้าร่วมโปรโมชั่น</h1>
            <div class="sub">DoHome นครสวรรค์ • Promo Checker</div>
          </div>
        </header>

        <section class="panel" aria-label="Promo Checker">
          <div class="panel-inner">
            <p class="hint">กรอกรหัสสินค้า <b>8 หลัก</b> แล้วกด “ตรวจสอบ” (หรือกด Enter)</p>

            <div class="form">
              <div class="field">
                <span class="icon-left" aria-hidden="true">⌁</span>
                <input
                  id="codeInput"
                  type="tel"
                  inputmode="numeric"
                  maxlength="8"
                  autocomplete="off"
                  placeholder="เช่น 10012977"
                  aria-label="รหัสสินค้า 8 หลัก"
                />
              </div>
              <button id="checkBtn" class="btn" type="button">ตรวจสอบ</button>
            </div>

            <div class="result" id="resultArea" aria-live="polite" aria-atomic="true"></div>
          </div>
        </section>

        <div class="footer">
          ใช้ฐานข้อมูลจาก Google Sheet (Blacklist) • เรียกผ่าน JSONP • ปรับ API ได้ที่ตัวแปร <code>API_URL</code>
        </div>
      </main>
    </div>

    <script>
      // =========================
      // ตั้งค่า API URL ตรงนี้
      // =========================
      // Max: เปลี่ยนเป็น URL จริงจาก Apps Script Web App (ลงท้ายด้วย /exec)
      // ตัวอย่าง: https://script.google.com/macros/s/AKfycbxxxxxxxxxxxxxxxxxxxx/exec
      const API_URL = "https://script.google.com/macros/s/AKfycby8yW6HSiy-ryBw7cy8anLvPkZwZuGDJE7jAc1QR69nkDqMGvh-JCSGwTtLqUSuXr74/exec";

      // เก็บ state ป้องกันการตอบกลับซ้อน (กรณีกดหลายครั้งเร็ว ๆ)
      let activeRequestId = 0;
      let jsonpScriptEl = null;
      let jsonpTimeout = null;

      const codeInput = document.getElementById("codeInput");
      const checkBtn = document.getElementById("checkBtn");
      const resultArea = document.getElementById("resultArea");

      /**
       * normalizeInput:
       * - เอาเฉพาะตัวเลข
       * - จำกัดไม่เกิน 8 หลัก
       */
      function normalizeInput(value) {
        return String(value || "").replace(/\D/g, "").slice(0, 8);
      }

      function setCard({ type, icon, title, codeText, nameText, noteText }) {
        const safeTitle = title || "";
        const safeCode = codeText || "";
        const safeName = nameText || "";
        const safeNote = noteText || "";

        resultArea.innerHTML = `
          <div class="card ${type}">
            <div class="badge" aria-hidden="true">${icon}</div>
            <div>
              <h2>${escapeHtml(safeTitle)}</h2>
              <div class="rows">
                <div><b>รหัสที่ตรวจสอบ:</b> ${escapeHtml(safeCode)}</div>
                <div><b>ชื่อสินค้า:</b> ${escapeHtml(safeName)}</div>
              </div>
              <div class="note">${escapeHtml(safeNote)}</div>
            </div>
          </div>
        `;
      }

      function setInlineMessage(msg) {
        resultArea.innerHTML = `<div class="hint" style="margin:10px 0 0 0;">${escapeHtml(msg)}</div>`;
      }

      function setBusy(isBusy) {
        checkBtn.disabled = isBusy;
        codeInput.disabled = isBusy;
      }

      function clearJsonp() {
        if (jsonpTimeout) {
          clearTimeout(jsonpTimeout);
          jsonpTimeout = null;
        }
        if (jsonpScriptEl && jsonpScriptEl.parentNode) {
          jsonpScriptEl.parentNode.removeChild(jsonpScriptEl);
        }
        jsonpScriptEl = null;
      }

      function handleCheck() {
        const normalized = normalizeInput(codeInput.value);
        codeInput.value = normalized; // ให้ผู้ใช้เห็นว่าเราตัดตัวอื่นออกแล้ว

        if (!/^\d{8}$/.test(normalized)) {
          setCard({
            type: "warning",
            icon: "!",
            title: "กรอกข้อมูลไม่ถูกต้อง",
            codeText: normalized || "-",
            nameText: "-",
            noteText: "กรุณากรอกรหัสสินค้าให้ครบ 8 หลัก",
          });
          return;
        }

        if (API_URL.includes("/XXXX/exec") || API_URL.endsWith("/XXXX/exec") || API_URL.includes("XXXX/exec")) {
          setCard({
            type: "warning",
            icon: "!",
            title: "ยังไม่ได้ตั้งค่า API",
            codeText: normalized,
            nameText: "-",
            noteText: "ให้แก้ตัวแปร API_URL ในไฟล์นี้เป็น URL จริงจาก Apps Script (ลงท้าย /exec) ก่อนใช้งาน",
          });
          return;
        }

        // เริ่ม request ใหม่
        activeRequestId += 1;
        const requestId = activeRequestId;

        setBusy(true);
        setInlineMessage("กำลังตรวจสอบ...");

        clearJsonp();

        // ใช้ JSONP เพื่อเลี่ยงปัญหา CORS:
        // สร้าง <script src="...&callback=handlePromoResult">
        const url =
          API_URL +
          "?code=" +
          encodeURIComponent(normalized) +
          "&callback=handlePromoResult" +
          "&_=" +
          Date.now(); // กัน cache

        const s = document.createElement("script");
        s.src = url;
        s.async = true;
        s.defer = true;

        // ถ้าโหลด script ไม่ได้ (เช่น URL ผิด) จะเข้า onerror
        s.onerror = function () {
          if (requestId !== activeRequestId) return;
          setBusy(false);
          setCard({
            type: "warning",
            icon: "!",
            title: "เรียก API ไม่สำเร็จ",
            codeText: normalized,
            nameText: "-",
            noteText: "ตรวจสอบ API_URL / การ Deploy Apps Script / อินเทอร์เน็ต แล้วลองใหม่",
          });
          clearJsonp();
        };

        // ตั้ง timeout กันค้าง (กรณี API ไม่ตอบกลับ)
        jsonpTimeout = setTimeout(function () {
          if (requestId !== activeRequestId) return;
          setBusy(false);
          setCard({
            type: "warning",
            icon: "!",
            title: "หมดเวลาในการตรวจสอบ",
            codeText: normalized,
            nameText: "-",
            noteText: "สัญญาณเน็ตช้า หรือ API มีปัญหา ลองใหม่อีกครั้ง",
          });
          clearJsonp();
        }, 8000);

        jsonpScriptEl = s;
        document.body.appendChild(s);
      }

      /**
       * ฟังก์ชันนี้จะถูกเรียกโดย Apps Script (JSONP):
       * handlePromoResult({ ok:true, code:"10012977", found:true/false, name:"..." })
       */
      window.handlePromoResult = function (result) {
        // หมายเหตุ: JSONP ไม่มี requestId แนบมา → เราใช้ activeRequestId เพื่อกันการตอบกลับจาก request เก่า
        // (ถ้ากดซ้อนเร็ว ๆ request เก่าอาจตอบกลับทีหลัง)
        const currentRequestId = activeRequestId;
        if (!result || typeof result !== "object") {
          setBusy(false);
          setCard({
            type: "warning",
            icon: "!",
            title: "ข้อมูลตอบกลับไม่ถูกต้อง",
            codeText: codeInput.value || "-",
            nameText: "-",
            noteText: "API ส่งข้อมูลผิดรูปแบบ กรุณาแจ้งผู้ดูแลระบบ",
          });
          clearJsonp();
          return;
        }

        // ปิดสถานะ busy ทันทีเมื่อได้ผลลัพธ์
        setBusy(false);
        clearJsonp();

        // ถ้าระบบฝั่ง API แจ้งว่า ok=false
        if (!result.ok) {
          setCard({
            type: "warning",
            icon: "!",
            title: "ระบบตรวจสอบมีปัญหา",
            codeText: (result.code || codeInput.value || "-"),
            nameText: "-",
            noteText: result.message ? String(result.message) : "ไม่สามารถตรวจสอบได้ในขณะนี้",
          });
          return;
        }

        const code = result.code ? String(result.code) : (codeInput.value || "-");
        const found = result.found === true;
        const name = result.name != null ? String(result.name).trim() : "";

        if (found) {
          setCard({
            type: "danger",
            icon: "✖",
            title: "ไม่ร่วมโปรโมชั่น",
            codeText: code,
            nameText: name ? name : "(ไม่ระบุ)",
            noteText: "สินค้าอยู่ในรายการยกเว้น โปรดตรวจสอบกับหัวหน้าแผนกหรือฝ่ายการตลาดอีกครั้ง",
          });
        } else {
          setCard({
            type: "success",
            icon: "✔",
            title: "ร่วมโปรโมชั่น",
            codeText: code,
            nameText: "- (ไม่มีในรายการยกเว้น)",
            noteText: "สามารถเสนอขายตามเงื่อนไขโปรโมชั่นได้",
          });
        }
      };

      // ป้องกัน XSS ในการ render ข้อความ (ถึงแม้ข้อมูลมาจากเราเองก็ตาม)
      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // UX: พิมพ์แล้วตัดให้เหลือเลขทันที
      codeInput.addEventListener("input", function () {
        const normalized = normalizeInput(codeInput.value);
        if (codeInput.value !== normalized) codeInput.value = normalized;
      });

      // กด Enter เพื่อเช็ค
      codeInput.addEventListener("keydown", function (ev) {
        if (ev.key === "Enter") {
          ev.preventDefault();
          handleCheck();
        }
      });

      checkBtn.addEventListener("click", handleCheck);

      // โฟกัส input ทันที (สะดวกในพื้นร้าน)
      window.addEventListener("load", function () {
        try { codeInput.focus(); } catch (_) {}
      });
    </script>
  </body>
</html>


