<!doctype html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#0b1220" />
    <title>Check No Promotion • DoHome นครสวรรค์</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />

    <!-- Google Font: Prompt -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg0: #070b12;
        --bg1: #0b1220;
        --card: rgba(255, 255, 255, 0.06);
        --border: rgba(255, 255, 255, 0.10);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.70);
        --muted2: rgba(255, 255, 255, 0.58);
        --orange: #f97316; /* DoHome-ish */
        --orange2: #fb923c;
        --greenBg: rgba(34, 197, 94, 0.14);
        --greenBd: rgba(34, 197, 94, 0.35);
        --greenTx: #86efac;
        --redBg: rgba(239, 68, 68, 0.14);
        --redBd: rgba(239, 68, 68, 0.35);
        --redTx: #fca5a5;
        --warnBg: rgba(245, 158, 11, 0.12);
        --warnBd: rgba(245, 158, 11, 0.35);
        --warnTx: #fcd34d;
        --shadow: 0 18px 48px rgba(0, 0, 0, 0.45);
        --radius: 18px;
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: "Prompt", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
        color: var(--text);
        background:
          radial-gradient(900px 600px at 20% -10%, rgba(249, 115, 22, 0.20), transparent 60%),
          radial-gradient(700px 500px at 90% 10%, rgba(59, 130, 246, 0.18), transparent 60%),
          radial-gradient(700px 500px at 50% 120%, rgba(34, 197, 94, 0.10), transparent 55%),
          linear-gradient(180deg, var(--bg0), var(--bg1));
      }

      .wrap {
        min-height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 22px 14px 34px;
      }

      .app {
        width: 100%;
        max-width: 520px;
      }

      .top {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 14px;
      }

      .logo {
        width: 54px;
        height: 54px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        box-shadow: 0 10px 28px rgba(0,0,0,0.35);
        flex: 0 0 auto;
      }
      .logo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .title {
        line-height: 1.15;
      }
      .title h1 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        letter-spacing: 0.2px;
      }
      .title .sub {
        margin-top: 4px;
        font-size: 13px;
        color: var(--muted2);
      }

      .panel {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .panel-inner {
        padding: 18px;
      }

      /* Tabs UI */
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 0;
      }
      .tab {
        flex: 1;
        border: 0;
        background: transparent;
        color: var(--muted);
        font-family: inherit;
        font-size: 14px;
        font-weight: 600;
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: color 150ms ease, border-color 150ms ease;
        position: relative;
        top: 1px;
      }
      .tab:hover {
        color: var(--text);
      }
      .tab.active {
        color: var(--orange);
        border-bottom-color: var(--orange);
      }

      .hint {
        color: var(--muted);
        font-size: 13px;
        margin: 0 0 12px 0;
      }

      .form {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .btn-secondary {
        width: 100%;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(0, 0, 0, 0.22);
        color: rgba(255, 255, 255, 0.90);
        font-family: inherit;
        font-weight: 800;
        font-size: 15px;
        border-radius: 14px;
        padding: 12px 14px;
        cursor: pointer;
        transition: transform 120ms ease, filter 120ms ease, box-shadow 120ms ease, border-color 120ms ease;
      }
      .btn-secondary:hover { border-color: rgba(249, 115, 22, 0.40); }
      .btn-secondary:active { transform: translateY(1px) scale(0.99); }
      .btn-secondary:disabled {
        cursor: not-allowed;
        filter: grayscale(0.2) brightness(0.85);
      }

      /* Scanner modal */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.62);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 18px 14px;
        z-index: 9999;
      }
      .modal.hidden { display: none; }
      .modal-card {
        width: 100%;
        max-width: 520px;
        background: rgba(12, 18, 32, 0.92);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 18px;
        box-shadow: 0 22px 60px rgba(0,0,0,0.55);
        overflow: hidden;
      }
      .modal-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 14px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.10);
      }
      .modal-title {
        font-weight: 800;
        letter-spacing: 0.2px;
      }
      .modal-close {
        border: 0;
        background: rgba(255,255,255,0.08);
        color: rgba(255,255,255,0.9);
        border: 1px solid rgba(255,255,255,0.12);
        padding: 8px 10px;
        border-radius: 12px;
        cursor: pointer;
        font-family: inherit;
        font-weight: 800;
      }
      .modal-body {
        padding: 12px 14px 14px;
      }
      .video-wrap {
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(0,0,0,0.35);
        aspect-ratio: 3 / 4;
      }
      video#scannerVideo {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .scan-frame {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        pointer-events: none;
      }
      .scan-box {
        width: min(86%, 360px);
        height: 120px;
        border-radius: 14px;
        border: 2px solid rgba(249, 115, 22, 0.85);
        box-shadow: 0 0 0 6px rgba(249, 115, 22, 0.12);
      }
      .scan-hint {
        margin: 10px 2px 0;
        color: rgba(255,255,255,0.78);
        font-size: 13px;
        line-height: 1.35;
      }
      .scan-hint b { color: rgba(255,255,255,0.92); }

      .scan-actions {
        margin-top: 12px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .scan-actions .btn-secondary {
        padding: 12px 14px;
      }

      .field {
        position: relative;
      }

      input[type="tel"] {
        width: 100%;
        appearance: none;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(0, 0, 0, 0.22);
        color: var(--text);
        border-radius: 14px;
        padding: 14px 14px 14px 44px;
        font-size: 18px;
        font-weight: 600;
        letter-spacing: 2px;
        outline: none;
        transition: border-color 150ms ease, box-shadow 150ms ease, transform 150ms ease;
      }
      input[type="tel"]:focus {
        border-color: rgba(249, 115, 22, 0.55);
        box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.18);
        transform: translateY(-1px);
      }

      .icon-left {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        opacity: 0.9;
        color: var(--orange2);
      }

      .btn {
        width: 100%;
        border: 0;
        background: linear-gradient(180deg, var(--orange2), var(--orange));
        color: #1a120c;
        font-family: inherit;
        font-weight: 800;
        font-size: 16px;
        border-radius: 14px;
        padding: 14px 16px;
        cursor: pointer;
        transition: transform 120ms ease, filter 120ms ease, box-shadow 120ms ease;
        box-shadow: 0 14px 28px rgba(249, 115, 22, 0.25);
      }
      .btn:active { transform: translateY(1px) scale(0.99); }
      .btn:disabled {
        cursor: not-allowed;
        filter: grayscale(0.2) brightness(0.85);
        box-shadow: none;
      }

      .result {
        margin-top: 14px;
      }

      .card {
        border-radius: 16px;
        padding: 14px 14px 12px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.06);
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 12px;
        align-items: start;
        animation: pop 180ms ease-out;
      }

      @keyframes pop {
        from { transform: translateY(4px); opacity: 0.6; }
        to { transform: translateY(0); opacity: 1; }
      }

      .badge {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 900;
        border: 1px solid var(--border);
        background: rgba(0,0,0,0.18);
        user-select: none;
      }

      .card h2 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.2px;
      }

      .rows {
        margin-top: 8px;
        display: grid;
        gap: 6px;
        color: var(--muted);
        font-size: 14px;
        line-height: 1.35;
      }

      .rows b {
        color: rgba(255,255,255,0.86);
        font-weight: 700;
      }

      .note {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed rgba(255,255,255,0.16);
        color: rgba(255,255,255,0.78);
        font-size: 13px;
      }

      .card.success {
        background: var(--greenBg);
        border-color: var(--greenBd);
      }
      .card.success .badge {
        border-color: rgba(34, 197, 94, 0.50);
        background: rgba(34, 197, 94, 0.16);
        color: var(--greenTx);
      }

      .card.danger {
        background: var(--redBg);
        border-color: var(--redBd);
      }
      .card.danger .badge {
        border-color: rgba(239, 68, 68, 0.55);
        background: rgba(239, 68, 68, 0.16);
        color: var(--redTx);
      }

      .card.warning {
        background: var(--warnBg);
        border-color: var(--warnBd);
      }
      .card.warning .badge {
        border-color: rgba(245, 158, 11, 0.55);
        background: rgba(245, 158, 11, 0.14);
        color: var(--warnTx);
      }

      .footer {
        margin-top: 14px;
        color: rgba(255,255,255,0.45);
        font-size: 12px;
        text-align: center;
      }
      .footer code {
        color: rgba(255,255,255,0.65);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }

      @media (min-width: 520px) {
        .panel-inner { padding: 20px; }
        .title h1 { font-size: 20px; }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <main class="app" role="main">
        <header class="top" aria-label="Header">
          <div class="logo" title="โลโก้ DoHome (ใส่ไฟล์เอง)">
            <!-- Max: วางไฟล์โลโก้ชื่อ logo.png ในโฟลเดอร์เดียวกับ index.html แล้วจะแสดงอัตโนมัติ -->
            <img src="logo.png" alt="DoHome นครสวรรค์" onerror="this.style.display='none';" />
          </div>
          <div class="title">
            <h1>ตรวจสอบสินค้าเข้าร่วมโปรโมชั่น</h1>
            <div class="sub">DoHome นครสวรรค์ • Promo Checker</div>
          </div>
        </header>

        <section class="panel" aria-label="Promo Checker">
          <div class="panel-inner">
            <div class="tabs" role="tablist" aria-label="เลือกโปรโมชั่น">
              <button id="tabCoupon" class="tab active" type="button" role="tab" aria-selected="true" aria-controls="promo-content">โปรโมชั่นคูปอง</button>
              <button id="tabFamily" class="tab" type="button" role="tab" aria-selected="false" aria-controls="promo-content">โปรโมชั่นครอบครัวช่าง</button>
            </div>
            <p class="hint">กรอกรหัสสินค้า <b>8 หลัก</b> แล้วกด "ตรวจสอบ" (หรือกด Enter)</p>

            <div class="form">
              <div class="field">
                <span class="icon-left" aria-hidden="true">⌁</span>
                <input
                  id="codeInput"
                  type="tel"
                  inputmode="numeric"
                  maxlength="8"
                  autocomplete="off"
                  placeholder="เช่น 10012977"
                  aria-label="รหัสสินค้า 8 หลัก"
                />
              </div>
              <button id="scanBtn" class="btn-secondary" type="button">สแกนบาร์โค้ด (beta) </button>
              <button id="checkBtn" class="btn" type="button">ตรวจสอบ</button>
            </div>

            <div class="result" id="resultArea" aria-live="polite" aria-atomic="true"></div>
          </div>
        </section>

        <div class="footer">
          ใช้ฐานข้อมูลจาก Google Sheet (Blacklist) • เรียกผ่าน JSONP • ปรับ API ได้ที่ตัวแปร <code>API_URL</code>
        </div>
      </main>
    </div>

    <!-- Scanner Modal (ต้องอยู่ก่อน <script> เพื่อให้ JS หา element ได้ทันที) -->
    <div id="scannerModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="สแกนบาร์โค้ด">
      <div class="modal-card">
        <div class="modal-head">
          <div class="modal-title">สแกนบาร์โค้ด</div>
          <button id="scanCloseBtn" class="modal-close" type="button">ย้อนกลับ</button>
        </div>
        <div class="modal-body">
          <div class="video-wrap">
            <video id="scannerVideo" playsinline muted autoplay></video>
            <div class="scan-frame" aria-hidden="true"><div class="scan-box"></div></div>
          </div>
          <div id="scanStatus" class="scan-hint">กำลังเตรียมกล้อง…</div>
          <div class="scan-actions">
            <button id="scanRetryBtn" class="btn-secondary" type="button">ลองเปิดกล้องใหม่</button>
            <button id="scanBackBtn" class="btn-secondary" type="button">ย้อนกลับ</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // =========================
      // ตั้งค่า API URL ตรงนี้
      // =========================
      // Max: เปลี่ยนเป็น URL จริงจาก Apps Script Web App (ลงท้ายด้วย /exec)
      // ตัวอย่าง: https://script.google.com/macros/s/AKfycbxxxxxxxxxxxxxxxxxxxx/exec
      const API_URL = "https://script.google.com/macros/s/AKfycbxaR636vHj-IwLM5JO9Kqo5qWYfQaW-LpbGP-aqej5JdzEmbpvJwWQh6yUxbsMFjss/exec";

      // ปรับได้ตามสภาพหน้างาน: มือถือ/เน็ตช้าแนะนำ 15–25 วินาที
      const JSONP_TIMEOUT_MS = 20000;

      // เก็บ state ป้องกันการตอบกลับซ้อน (กรณีกดหลายครั้งเร็ว ๆ)
      let activeRequestId = 0;
      let jsonpScriptEl = null;
      let jsonpTimeout = null;
      let statusInterval = null;
      let requestStartedAt = 0;

      // Promo state
      let currentPromoKey = "coupon"; // default = coupon
      const PROMO_CONFIG = {
        coupon: { key: "coupon", name: "โปรโมชั่นคูปอง" },
        family: { key: "family", name: "โปรโมชั่นครอบครัวช่าง" }
      };

      const codeInput = document.getElementById("codeInput");
      const scanBtn = document.getElementById("scanBtn");
      const checkBtn = document.getElementById("checkBtn");
      const resultArea = document.getElementById("resultArea");
      const tabCoupon = document.getElementById("tabCoupon");
      const tabFamily = document.getElementById("tabFamily");

      // ========= Scanner state =========
      const scannerModal = document.getElementById("scannerModal");
      const scanCloseBtn = document.getElementById("scanCloseBtn");
      const scanRetryBtn = document.getElementById("scanRetryBtn");
      const scanBackBtn = document.getElementById("scanBackBtn");
      const scannerVideo = document.getElementById("scannerVideo");
      const scanStatus = document.getElementById("scanStatus");
      let scannerStream = null;
      let scannerRunning = false;
      let detector = null;
      let lastScanAt = 0;
      let zxingReader = null;
      let zxingControls = null;
      let zxingLoading = false;
      let scannerStopRequested = false;
      let reopenAttempts = 0;
      let scannerStartAt = 0;
      let wakeLock = null;
      let detectInFlight = false;
      let usingZxing = false;
      let lastDetectedRaw = "";

      /**
       * normalizeInput:
       * - เอาเฉพาะตัวเลข
       * - จำกัดไม่เกิน 8 หลัก
       */
      function normalizeInput(value) {
        return String(value || "").replace(/\D/g, "").slice(0, 8);
      }

      function setCard({ type, icon, title, promoName, codeText, nameText, noteText }) {
        const safeTitle = title || "";
        const safePromo = promoName || "";
        const safeCode = codeText || "";
        const safeName = nameText || "";
        const safeNote = noteText || "";

        resultArea.innerHTML = `
          <div class="card ${type}">
            <div class="badge" aria-hidden="true">${icon}</div>
            <div>
              <h2>${escapeHtml(safeTitle)}</h2>
              <div class="rows">
                ${safePromo ? `<div><b>โปรโมชั่น:</b> ${escapeHtml(safePromo)}</div>` : ""}
                <div><b>รหัสที่ตรวจสอบ:</b> ${escapeHtml(safeCode)}</div>
                <div><b>ชื่อสินค้า:</b> ${escapeHtml(safeName)}</div>
              </div>
              <div class="note">${escapeHtml(safeNote)}</div>
            </div>
          </div>
        `;
      }

      function setInlineMessage(msg) {
        resultArea.innerHTML = `<div class="hint" style="margin:10px 0 0 0;">${escapeHtml(msg)}</div>`;
      }

      function setBusy(isBusy) {
        checkBtn.disabled = isBusy;
        codeInput.disabled = isBusy;
        scanBtn.disabled = isBusy;
      }

      function isApiConfigured() {
        return !(API_URL.includes("/XXXX/exec") || API_URL.endsWith("/XXXX/exec") || API_URL.includes("XXXX/exec"));
      }

      function apiShort() {
        try {
          const u = new URL(API_URL);
          return u.host + u.pathname;
        } catch (_) {
          return API_URL;
        }
      }

      function clearJsonp() {
        if (jsonpTimeout) {
          clearTimeout(jsonpTimeout);
          jsonpTimeout = null;
        }
        if (statusInterval) {
          clearInterval(statusInterval);
          statusInterval = null;
        }
        if (jsonpScriptEl && jsonpScriptEl.parentNode) {
          jsonpScriptEl.parentNode.removeChild(jsonpScriptEl);
        }
        jsonpScriptEl = null;
      }

      // ===== Barcode scanning (Camera) =====
      function setScanStatus(msg) {
        if (!scanStatus) return;
        scanStatus.textContent = msg;
      }

      function showScanner() {
        if (!scannerModal) {
          console.error("Scanner modal element not found (#scannerModal).");
          setCard({
            type: "warning",
            icon: "!",
            title: "เปิดกล้องไม่ได้",
            codeText: codeInput.value || "-",
            nameText: "-",
            noteText: "ไม่พบหน้าต่างสแกน (scannerModal) กรุณารีเฟรชหน้า หรืออัปเดตไฟล์หน้าเว็บให้เป็นเวอร์ชันล่าสุด",
          });
          return;
        }
        scannerModal.classList.remove("hidden");
      }

      function hideScanner() {
        if (!scannerModal) return;
        scannerModal.classList.add("hidden");
      }

      function resetScannerUi() {
        // ทำให้ modal เปิดค้างได้แม้กล้องหลุด
        if (scannerVideo) {
          try { scannerVideo.poster = ""; } catch (_) {}
        }
      }

      async function requestWakeLock() {
        try {
          if (navigator.wakeLock && navigator.wakeLock.request) {
            wakeLock = await navigator.wakeLock.request("screen");
          }
        } catch (_) {
          // ไม่รองรับก็ไม่เป็นไร
        }
      }

      async function releaseWakeLock() {
        try {
          if (wakeLock && wakeLock.release) await wakeLock.release();
        } catch (_) {}
        wakeLock = null;
      }

      function isSecureContextOk() {
        // กล้องบนเว็บต้องเป็น HTTPS (ยกเว้น localhost)
        return window.isSecureContext || location.hostname === "localhost";
      }

      function extract8DigitCode(rawValue) {
        const digits = String(rawValue || "").replace(/\D/g, "");
        if (/^\d{8}$/.test(digits)) return digits;
        // บางบาร์โค้ดเป็น EAN-13/UPC-A → เอา 8 หลักท้ายสุดมา (ตามการใช้งานหน้างาน)
        if (digits.length > 8) return digits.slice(-8);
        // ถ้ามีเลขติดกัน >= 8 ให้ดึงช่วง 8 หลักแรกที่เจอ
        const m = digits.match(/\d{8}/);
        return m ? m[0] : "";
      }

      // ถ้าอ่านได้ “อะไรก็ตาม” ให้ส่งผ่านฟังก์ชันนี้ เพื่อ:
      // - แปลงเป็นรหัส 8 หลักถ้าเป็นไปได้
      // - ถ้าไม่ใช่ 8 หลัก ให้โชว์ว่าอ่านได้ (ช่วย debug/หน้างาน)
      function onBarcodeCandidate(raw) {
        lastDetectedRaw = String(raw || "");
        const code = extract8DigitCode(lastDetectedRaw);
        if (/^\d{8}$/.test(code)) {
          setScanStatus("พบรหัส: " + code + " กำลังตรวจสอบ…");
          codeInput.value = code;
          setTimeout(() => {
            closeScanner();
            handleCheck();
          }, 180);
          return true;
        }

        if (lastDetectedRaw) {
          setScanStatus("อ่านได้: " + lastDetectedRaw + " (ยังไม่ใช่รหัส 8 หลัก) ลองขยับให้ชัด/ใกล้ขึ้น");
        }
        return false;
      }

      async function loadZxingIfNeeded() {
        // โหลด ZXing (fallback) เมื่อ BarcodeDetector ไม่รองรับ
        // - ใช้ UMD build ผ่าน jsDelivr
        if (window.ZXingBrowser) return window.ZXingBrowser;
        if (zxingLoading) {
          // รอจนโหลดเสร็จ
          return new Promise((resolve, reject) => {
            const started = Date.now();
            const t = setInterval(() => {
              if (window.ZXingBrowser) {
                clearInterval(t);
                resolve(window.ZXingBrowser);
              } else if (Date.now() - started > 12000) {
                clearInterval(t);
                reject(new Error("ZXing load timeout"));
              }
            }, 120);
          });
        }

        zxingLoading = true;
        try {
          await new Promise((resolve, reject) => {
            const s = document.createElement("script");
            // เวอร์ชันถูก pin เพื่อลดความเสี่ยง break จาก latest
            s.src = "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js";
            s.async = true;
            s.onload = () => resolve();
            s.onerror = () => reject(new Error("โหลด ZXing ไม่สำเร็จ"));
            document.head.appendChild(s);
          });
          if (!window.ZXingBrowser) throw new Error("ZXing ไม่พร้อมใช้งาน");
          return window.ZXingBrowser;
        } finally {
          zxingLoading = false;
        }
      }

      async function getBackCameraStream() {
        // พยายามเปิด "กล้องหลัง" ให้มากที่สุด:
        // 1) facingMode exact
        // 2) facingMode ideal
        // 3) เลือก deviceId จาก enumerateDevices (หลังขอสิทธิ์แล้ว label จะมีค่า)
        const tryConstraints = async (video) => {
          return await navigator.mediaDevices.getUserMedia({
            video,
            audio: false,
          });
        };

        try {
          return await tryConstraints({
            facingMode: { exact: "environment" },
            width: { ideal: 1280 },
            height: { ideal: 720 },
          });
        } catch (_) {}

        try {
          return await tryConstraints({
            facingMode: { ideal: "environment" },
            width: { ideal: 1280 },
            height: { ideal: 720 },
          });
        } catch (_) {}

        // ขอ stream ทั่วไปก่อนเพื่อให้ browser ขอ permission (บางเครื่อง enumerateDevices label จะว่างถ้ายังไม่ขอสิทธิ์)
        let tmp = null;
        try {
          tmp = await tryConstraints({ video: true });
        } catch (_) {
          // ถ้าขอแบบทั่วไปยังไม่ได้ ก็ให้ throw ไป
        }
        if (tmp) {
          try { tmp.getTracks().forEach((t) => t.stop()); } catch (_) {}
        }

        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter((d) => d.kind === "videoinput");
        // เลือกตัวที่ label ดูเป็นกล้องหลัง (keyword) ถ้าไม่มี ให้เลือกตัวสุดท้าย (มักเป็น rear)
        const keyword = /(back|rear|environment)/i;
        const preferred = cams.find((c) => keyword.test(c.label)) || cams[cams.length - 1];
        if (!preferred) throw new Error("ไม่พบอุปกรณ์กล้อง (videoinput)");

        return await tryConstraints({
          deviceId: { exact: preferred.deviceId },
          width: { ideal: 1280 },
          height: { ideal: 720 },
        });
      }

      async function openScanner() {
        if (!isSecureContextOk()) {
          showScanner();
          setScanStatus("ต้องเปิดผ่าน HTTPS เพื่อใช้กล้อง (แนะนำ Cloudflare/GitHub Pages) หรือพิมพ์รหัสแทน");
          return;
        }
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          showScanner();
          setScanStatus("เบราวเซอร์นี้ไม่รองรับการเปิดกล้อง กรุณาใช้ Chrome/Edge หรือพิมพ์รหัสแทน");
          return;
        }

        scannerStopRequested = false;
        reopenAttempts = 0;
        scannerStartAt = Date.now();
        detectInFlight = false;
        usingZxing = false;
        lastDetectedRaw = "";
        showScanner();
        resetScannerUi();
        setScanStatus("กำลังขอสิทธิ์กล้อง…");

        try {
          // ปิดของเดิม (กันกดซ้อน)
          if (scannerStream) {
            try { scannerStream.getTracks().forEach((t) => t.stop()); } catch (_) {}
            scannerStream = null;
          }

          await requestWakeLock();
          scannerStream = await getBackCameraStream();

          scannerVideo.srcObject = scannerStream;
          await scannerVideo.play();

          // ถ้ากล้องดับเอง/track ended → แจ้งให้รู้ (ช่วย debug มือถือ/บางบราวเซอร์)
          try {
            const vt = scannerStream.getVideoTracks && scannerStream.getVideoTracks()[0];
            if (vt) {
              vt.onended = () => {
                if (scannerStopRequested) return;
                // บางเครื่อง track จะ end เองเร็ว ๆ (เช่น in-app browser/permission/OS)
                scannerRunning = false;
                // auto-retry หลายครั้งแบบสุภาพ (กันกรณีเปิด 1–2 วิแล้วดับ)
                if (reopenAttempts < 3) {
                  reopenAttempts += 1;
                  setScanStatus("กล้องหลุด กำลังเปิดใหม่… (" + reopenAttempts + "/3)");
                  setTimeout(async () => {
                    if (scannerStopRequested) return;
                    try {
                      if (scannerStream) {
                        try { scannerStream.getTracks().forEach((t) => t.stop()); } catch (_) {}
                        scannerStream = null;
                      }
                      scannerStream = await getBackCameraStream();
                      scannerVideo.srcObject = scannerStream;
                      await scannerVideo.play();
                      scannerRunning = true;
                      setScanStatus("เล็งบาร์โค้ดให้อยู่ในกรอบ แล้วรอระบบอ่าน…");
                      if ("BarcodeDetector" in window) {
                        scanLoop();
                      }
                    } catch (e) {
                      const m = (e && e.name) ? String(e.name) : String(e);
                      setScanStatus("เปิดกล้องใหม่ไม่สำเร็จ: " + m + " (กด “ลองเปิดกล้องใหม่” หรือกด “ย้อนกลับ”)");
                    }
                  }, 450);
                  return;
                }
                setScanStatus("กล้องหยุดทำงานเองซ้ำ ๆ — กด “ลองเปิดกล้องใหม่” หรือเปิดผ่าน Chrome/Safari ปกติ (หลีกเลี่ยง in‑app browser)");
              };
              vt.onmute = () => {
                // บางเครื่อง mute ชั่วคราว
              };
              vt.onunmute = () => {
                // กลับมาได้
              };
            }
          } catch (_) {}

          scannerRunning = true;
          lastScanAt = 0;

          // 1) ใช้ BarcodeDetector ถ้ามี (เร็ว/ลื่น)
          if ("BarcodeDetector" in window) {
            if (!detector) {
              const formats = ["ean_13", "ean_8", "code_128", "upc_a", "upc_e", "qr_code"];
              detector = new BarcodeDetector({ formats });
            }
            setScanStatus("กำลังสแกน… เล็งบาร์โค้ดให้อยู่ในกรอบ แล้วรอระบบอ่าน…");
            scanLoop();

            // ถ้า BarcodeDetector อ่านไม่ติด ให้สลับไป ZXing อัตโนมัติ (ช่วยบางเครื่อง)
            setTimeout(() => {
              if (!scannerRunning || scannerStopRequested) return;
              if (usingZxing) return;
              if (!lastDetectedRaw) {
                switchToZxing().catch(() => {});
              }
            }, 3500);
            return;
          }

          // 2) Fallback: ZXing (รองรับ iOS Safari/บราวเซอร์อื่น ๆ ที่ไม่มี BarcodeDetector)
          await switchToZxing();
        } catch (err) {
          const msg = (err && err.name) ? String(err.name) : String(err);
          // สำคัญ: ไม่ปิด modal ทิ้ง ให้ user กด “ลองใหม่/ย้อนกลับ” เอง
          scannerRunning = false;
          setScanStatus("เปิดกล้องไม่สำเร็จ: " + msg + " (กด “ลองเปิดกล้องใหม่” หรือกด “ย้อนกลับ”)");
          // เคลียร์ stream ที่ค้าง แต่ไม่ซ่อน modal
          try {
            if (scannerStream) scannerStream.getTracks().forEach((t) => t.stop());
          } catch (_) {}
          scannerStream = null;
          releaseWakeLock();
        }
      }

      async function switchToZxing() {
        if (!scannerRunning || scannerStopRequested) return;
        if (usingZxing) return;
        usingZxing = true;

        setScanStatus("กำลังใช้โหมดสแกนแบบเข้ม (ZXing)…");
        const ZX = await loadZxingIfNeeded();
        if (!zxingReader) zxingReader = new ZX.BrowserMultiFormatReader();

        // หยุดของเดิมถ้ามี
        try {
          if (zxingControls && typeof zxingControls.stop === "function") zxingControls.stop();
        } catch (_) {}
        zxingControls = null;

        zxingReader.decodeFromVideoElementContinuously(scannerVideo, (result, _err, controls) => {
          if (controls) zxingControls = controls;
          if (!scannerRunning || scannerStopRequested) return;
          if (result) {
            const raw = result.getText ? result.getText() : String(result.text || "");
            onBarcodeCandidate(raw);
          }
        });
      }

      function closeScanner() {
        scannerStopRequested = true;
        scannerRunning = false;
        // หยุด ZXing ถ้ากำลังทำงาน
        try {
          if (zxingControls && typeof zxingControls.stop === "function") zxingControls.stop();
        } catch (_) {}
        zxingControls = null;
        if (scannerVideo) {
          try { scannerVideo.pause(); } catch (_) {}
          scannerVideo.srcObject = null;
        }
        if (scannerStream) {
          try {
            scannerStream.getTracks().forEach((t) => t.stop());
          } catch (_) {}
        }
        scannerStream = null;
        releaseWakeLock();
        hideScanner();
      }

      async function scanLoop() {
        if (!scannerRunning) return;
        if (usingZxing) return;

        // throttle: ไม่ต้อง detect ทุกเฟรม (ช่วยประหยัดแบต/ลื่นขึ้น)
        const now = Date.now();
        if (now - lastScanAt < 180) {
          requestAnimationFrame(scanLoop);
          return;
        }
        lastScanAt = now;

        try {
          if (!detector) {
            requestAnimationFrame(scanLoop);
            return;
          }
          if (detectInFlight) {
            requestAnimationFrame(scanLoop);
            return;
          }
          if (scannerVideo.readyState >= 2) {
            detectInFlight = true;
            const results = await detector.detect(scannerVideo);
            detectInFlight = false;
            if (results && results.length) {
              const raw = results[0].rawValue || "";
              if (raw) {
                if (onBarcodeCandidate(raw)) return;
              }
            }
          }
        } catch (_err) {
          // เงียบไว้ก่อน: บางเครื่อง detect จะ throw เป็นครั้งคราว
          detectInFlight = false;
        }

        requestAnimationFrame(scanLoop);
      }

      function handleCheck() {
        const normalized = normalizeInput(codeInput.value);
        codeInput.value = normalized; // ให้ผู้ใช้เห็นว่าเราตัดตัวอื่นออกแล้ว

        if (!/^\d{8}$/.test(normalized)) {
          setCard({
            type: "warning",
            icon: "!",
            title: "กรอกข้อมูลไม่ถูกต้อง",
            promoName: PROMO_CONFIG[currentPromoKey].name,
            codeText: normalized || "-",
            nameText: "-",
            noteText: "กรุณากรอกรหัสสินค้าให้ครบ 8 หลัก",
          });
          return;
        }

        if (!isApiConfigured()) {
          setCard({
            type: "warning",
            icon: "!",
            title: "ยังไม่ได้ตั้งค่า API",
            promoName: PROMO_CONFIG[currentPromoKey].name,
            codeText: normalized,
            nameText: "-",
            noteText: "ให้แก้ตัวแปร API_URL ในไฟล์นี้เป็น URL จริงจาก Apps Script (ลงท้าย /exec) ก่อนใช้งาน",
          });
          return;
        }

        // เริ่ม request ใหม่
        activeRequestId += 1;
        const requestId = activeRequestId;

        setBusy(true);
        requestStartedAt = Date.now();
        setInlineMessage("กำลังตรวจสอบ... (0s)");

        clearJsonp();

        // ใช้ JSONP เพื่อเลี่ยงปัญหา CORS:
        // สร้าง <script src="...&callback=handlePromoResult">
        const uniqueId = Date.now() + "_" + Math.random().toString(36).substr(2, 9);
        const callbackName = "__promo_cb_" + uniqueId;
        
        // กำหนด global callback function
        window[callbackName] = function(result) {
          // ลบ callback function หลังใช้งาน
          try { delete window[callbackName]; } catch (_) {}
          handlePromoResult(result);
        };

        const url =
          API_URL +
          "?code=" +
          encodeURIComponent(normalized) +
          "&promo=" +
          encodeURIComponent(currentPromoKey) +
          "&callback=" +
          encodeURIComponent(callbackName) +
          "&_=" +
          Date.now(); // กัน cache

        const s = document.createElement("script");
        s.src = url;
        s.async = true;
        s.defer = true;

        // อัปเดตสถานะเป็นวินาที (ให้ผู้ใช้รู้ว่ายังทำงานอยู่)
        statusInterval = setInterval(function () {
          const sec = Math.floor((Date.now() - requestStartedAt) / 1000);
          setInlineMessage("กำลังตรวจสอบ... (" + sec + "s)");
        }, 350);

        // ถ้าโหลด script ไม่ได้ (เช่น URL ผิด) จะเข้า onerror
        s.onerror = function () {
          if (requestId !== activeRequestId) return;
          // ลบ callback ที่สร้างไว้
          try { delete window[callbackName]; } catch (_) {}
          setBusy(false);
          setCard({
            type: "warning",
            icon: "!",
            title: "เรียก API ไม่สำเร็จ",
            promoName: PROMO_CONFIG[currentPromoKey].name,
            codeText: normalized,
            nameText: "-",
            noteText:
              "เชื่อมต่อเซิร์ฟเวอร์ไม่ได้ โปรดลองใหม่อีกครั้ง หรือตรวจสอบว่า Deploy Apps Script เป็น Web app และตั้ง Who has access = Anyone. API: " +
              apiShort(),
          });
          clearJsonp();
        };

        // ตั้ง timeout กันค้าง (กรณี API ไม่ตอบกลับ)
        jsonpTimeout = setTimeout(function () {
          if (requestId !== activeRequestId) return;
          // ลบ callback ที่สร้างไว้
          try { delete window[callbackName]; } catch (_) {}
          setBusy(false);
          setCard({
            type: "warning",
            icon: "!",
            title: "หมดเวลาในการตรวจสอบ",
            promoName: PROMO_CONFIG[currentPromoKey].name,
            codeText: normalized,
            nameText: "-",
            noteText:
              "เชื่อมต่อเซิร์ฟเวอร์ไม่ได้ โปรดลองใหม่อีกครั้ง (เน็ตมือถือช้า/Apps Script cold start อาจใช้เวลา 10–20 วินาที). API: " + apiShort(),
          });
          clearJsonp();
        }, JSONP_TIMEOUT_MS);

        jsonpScriptEl = s;
        document.body.appendChild(s);
      }

      /**
       * ฟังก์ชันนี้จะถูกเรียกโดย Apps Script (JSONP):
       * handlePromoResult({ ok:true, promo:"coupon", promoName:"...", code:"10012977", found:true/false, name:"..." })
       */
      function handlePromoResult(result) {
        // หมายเหตุ: JSONP ไม่มี requestId แนบมา → เราใช้ activeRequestId เพื่อกันการตอบกลับจาก request เก่า
        // (ถ้ากดซ้อนเร็ว ๆ request เก่าอาจตอบกลับทีหลัง)
        if (!result || typeof result !== "object") {
          setBusy(false);
          setCard({
            type: "warning",
            icon: "!",
            title: "ข้อมูลตอบกลับไม่ถูกต้อง",
            promoName: PROMO_CONFIG[currentPromoKey].name,
            codeText: codeInput.value || "-",
            nameText: "-",
            noteText: "API ส่งข้อมูลผิดรูปแบบ กรุณาแจ้งผู้ดูแลระบบ",
          });
          clearJsonp();
          return;
        }

        // ปิดสถานะ busy ทันทีเมื่อได้ผลลัพธ์
        setBusy(false);
        clearJsonp();

        // ถ้าระบบฝั่ง API แจ้งว่า ok=false
        if (!result.ok) {
          setCard({
            type: "warning",
            icon: "!",
            title: "ระบบตรวจสอบมีปัญหา",
            promoName: result.promoName || PROMO_CONFIG[currentPromoKey].name,
            codeText: (result.code || codeInput.value || "-"),
            nameText: "-",
            noteText: result.message ? String(result.message) : "ไม่สามารถตรวจสอบได้ในขณะนี้",
          });
          return;
        }

        const code = result.code ? String(result.code) : (codeInput.value || "-");
        const found = result.found === true;
        const name = result.name != null ? String(result.name).trim() : "";
        const promoName = result.promoName || PROMO_CONFIG[currentPromoKey].name;

        if (found) {
          setCard({
            type: "danger",
            icon: "✖",
            title: "ไม่ร่วมโปรโมชั่น",
            promoName: promoName,
            codeText: code,
            nameText: name ? name : "(ไม่ระบุ)",
            noteText: "สินค้าอยู่ในรายการยกเว้น โปรดตรวจสอบกับหัวหน้าแผนกหรือฝ่ายการตลาดอีกครั้ง",
          });
        } else {
          setCard({
            type: "success",
            icon: "✔",
            title: "ไม่ใช่รายการยกเว้นโปรโมชั่น",
            promoName: promoName,
            codeText: code,
            nameText: "- (ตรวจสอบสินค้าอยู่ใน RT ที่ร่วมโปรหรือไม่)",
            noteText: "แล้วค่อยเสนอขายตามเงื่อนไขโปรโมชั่นได้",
          });
        }
      }

      // ป้องกัน XSS ในการ render ข้อความ (ถึงแม้ข้อมูลมาจากเราเองก็ตาม)
      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // UX: พิมพ์แล้วตัดให้เหลือเลขทันที
      codeInput.addEventListener("input", function () {
        const normalized = normalizeInput(codeInput.value);
        if (codeInput.value !== normalized) codeInput.value = normalized;
      });

      // กด Enter เพื่อเช็ค
      codeInput.addEventListener("keydown", function (ev) {
        if (ev.key === "Enter") {
          ev.preventDefault();
          handleCheck();
        }
      });

      // Tab switching
      function switchPromo(promoKey) {
        if (!PROMO_CONFIG[promoKey]) return;
        currentPromoKey = promoKey;
        
        // Update tab UI
        tabCoupon.classList.toggle("active", promoKey === "coupon");
        tabCoupon.setAttribute("aria-selected", promoKey === "coupon" ? "true" : "false");
        tabFamily.classList.toggle("active", promoKey === "family");
        tabFamily.setAttribute("aria-selected", promoKey === "family" ? "true" : "false");
        
        // Clear result when switching
        resultArea.innerHTML = "";
      }

      tabCoupon.addEventListener("click", () => switchPromo("coupon"));
      tabFamily.addEventListener("click", () => switchPromo("family"));

      checkBtn.addEventListener("click", handleCheck);
      scanBtn.addEventListener("click", openScanner);
      scanCloseBtn.addEventListener("click", closeScanner);
      scanBackBtn.addEventListener("click", closeScanner);
      scanRetryBtn.addEventListener("click", async function () {
        // ไม่ปิด modal แต่พยายามเปิดกล้องใหม่
        scannerStopRequested = false;
        reopenAttempts = 0;
        setScanStatus("กำลังเปิดกล้องใหม่…");
        try {
          if (scannerStream) {
            try { scannerStream.getTracks().forEach((t) => t.stop()); } catch (_) {}
            scannerStream = null;
          }
          await requestWakeLock();
          scannerStream = await getBackCameraStream();
          scannerVideo.srcObject = scannerStream;
          await scannerVideo.play();
          scannerRunning = true;
          setScanStatus("เล็งบาร์โค้ดให้อยู่ในกรอบ แล้วรอระบบอ่าน…");
          if ("BarcodeDetector" in window) scanLoop();
        } catch (e) {
          const m = (e && e.name) ? String(e.name) : String(e);
          setScanStatus("เปิดกล้องใหม่ไม่สำเร็จ: " + m + " (ตรวจสิทธิ์กล้อง/ลอง Chrome/Safari)");
          releaseWakeLock();
        }
      });
      scannerModal.addEventListener("click", function (ev) {
        // คลิกพื้นหลังเพื่อปิด
        if (ev.target === scannerModal) closeScanner();
      });

      // โฟกัส input ทันที (สะดวกในพื้นร้าน)
      window.addEventListener("load", function () {
        try { codeInput.focus(); } catch (_) {}

        // JSONP warm-up: ช่วยลดหน่วงครั้งแรก (โดยเฉพาะมือถือ)
        if (isApiConfigured()) {
          window.handleWarmup = function (_result) {
            // ไม่ต้องทำอะไร แค่อุ่นเครื่อง Apps Script
          };

          const warmUrl = API_URL + "?ping=1&callback=handleWarmup&_=" + Date.now();
          const warm = document.createElement("script");
          warm.src = warmUrl;
          warm.async = true;
          warm.defer = true;
          warm.onload = function () { try { warm.remove(); } catch (_) {} };
          warm.onerror = function () { try { warm.remove(); } catch (_) {} };
          document.body.appendChild(warm);
        }
      });
    </script>
  </body>
</html>


